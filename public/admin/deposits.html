<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Manage Deposits | ElevateX Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/coolalertjs@latest/dist/coolalert.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=Space+Grotesk:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ["Outfit", "sans-serif"],
              display: ["Space Grotesk", "sans-serif"],
            },
            colors: {
              primary: "#0ea5e9",
              secondary: "#3b82f6",
              dark: "#0f172a",
              darker: "#020617",
              accent: "#22d3ee",
            },
          },
        },
      };
    </script>
    <style>
      body {
        background-color: #020617;
        color: #f8fafc;
      }
      .glass-panel {
        background: rgba(2, 6, 23, 0.7);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.08);
      }
    </style>
  </head>
  <body class="antialiased flex h-screen overflow-hidden">
    <aside
      id="sidebar"
      class="fixed lg:static inset-y-0 left-0 z-50 w-64 bg-[#020617] border-r border-white/5 transform -translate-x-full lg:translate-x-0 transition-transform duration-300 flex flex-col"
    >
      <div class="h-20 flex items-center px-8 border-b border-white/5">
        <div class="flex items-center gap-2">
          <span class="font-display font-bold text-xl text-white"
            >Elevate<span class="text-cyan-400">X</span></span
          >
          <span
            class="px-2 py-0.5 rounded text-[10px] bg-rose-500 text-white font-bold tracking-wider uppercase"
            >Admin</span
          >
        </div>
      </div>
      <nav class="flex-1 overflow-y-auto py-6 space-y-1">
        <p
          class="px-8 text-xs font-semibold text-slate-500 uppercase tracking-wider mb-2"
        >
          Overview
        </p>
        <a
          href="index.html"
          class="sidebar-link flex items-center gap-3 px-8 py-3 text-slate-400"
        >
          <svg
            class="w-5 h-5"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"
            ></path>
          </svg>
          Dashboard
        </a>

        <p
          class="px-8 text-xs font-semibold text-slate-500 uppercase tracking-wider mb-2 mt-6"
        >
          Management
        </p>
        <a
          href="users.html"
          class="sidebar-link flex items-center gap-3 px-8 py-3 text-slate-400"
        >
          <svg
            class="w-5 h-5"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"
            ></path>
          </svg>
          All Users
        </a>
        <a
          href="deposits.html"
          class="sidebar-link active flex items-center gap-3 px-8 py-3 text-slate-400"
        >
          <svg
            class="w-5 h-5"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
            ></path>
          </svg>
          Deposits
        </a>
        <a
          href="withdrawals.html"
          class="sidebar-link flex items-center gap-3 px-8 py-3 text-slate-400"
        >
          <svg
            class="w-5 h-5"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"
            ></path>
          </svg>
          Withdrawals
        </a>
        <a
          href="loans.html"
          class="sidebar-link flex items-center gap-3 px-8 py-3 text-slate-400"
        >
          <svg
            class="w-5 h-5"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
            ></path>
          </svg>
          Loan Requests
        </a>
        <p
          class="px-8 text-xs font-semibold text-slate-500 uppercase tracking-wider mb-2 mt-6"
        >
          Communication
        </p>
        <a
          href="email.html"
          class="sidebar-link flex items-center gap-3 px-8 py-3 text-slate-400"
        >
          <svg
            class="w-5 h-5"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"
            ></path>
          </svg>
          Send Email
        </a>
      </nav>
      <div class="p-6 border-t border-white/5">
        <button
          id="logoutBtn"
          class="flex items-center gap-2 text-sm text-slate-400 hover:text-white transition-colors"
        >
          Sign Out
        </button>
      </div>
    </aside>

    <main class="flex-1 flex flex-col h-screen overflow-hidden bg-[#020617]">
      <header
        class="h-20 flex items-center justify-between px-10 border-b border-white/5 bg-[#020617]/80"
      >
        <h1 class="text-xl font-bold text-white">Deposit Requests</h1>
      </header>

      <div class="flex-1 overflow-y-auto p-10">
        <div class="glass-panel rounded-2xl overflow-hidden">
          <table class="w-full text-left">
            <thead
              class="bg-white/5 text-slate-400 text-xs uppercase tracking-wider"
            >
              <tr>
                <th class="p-4">User</th>
                <th class="p-4">Method</th>
                <th class="p-4">Amount</th>
                <th class="p-4">Proof</th>
                <th class="p-4">Status</th>
                <th class="p-4 text-right">Actions</th>
              </tr>
            </thead>
            <tbody
              id="depositsTableBody"
              class="text-sm text-slate-300 divide-y divide-white/5"
            >
              <!-- Deposit requests will be injected here -->
            </tbody>
          </table>
        </div>
      </div>
    </main>

    <script type="module">
      import { Ui, apiCall, isLoggedIn, logout } from "../scripts/utils.js";

      // Sidebar Toggle Logic (copied from admin/index.html)
      const sidebarToggle = document.getElementById("sidebarToggle");
      const sidebar = document.getElementById("sidebar");
      const overlay = document.getElementById("sidebarOverlay");

      if (sidebarToggle && sidebar && overlay) {
        function toggleSidebar() {
          sidebar.classList.toggle("-translate-x-full");
          overlay.classList.toggle("hidden");
        }
        sidebarToggle.addEventListener("click", toggleSidebar);
        overlay.addEventListener("click", toggleSidebar);
      }

      // Check login status and admin role
      document.addEventListener("DOMContentLoaded", async () => {
        if (!isLoggedIn()) {
          window.location.href = "../login/";
          return;
        }

        const logoutBtn = document.getElementById("logoutBtn");
        if (logoutBtn) {
          logoutBtn.addEventListener("click", (e) => {
            e.preventDefault();
            Ui.alert(
              "question",
              "Admin Sign Out",
              "Securely logging out of administration panel..."
            ).then((result) => {
              if (result.isConfirmed) {
                logout();
              }
            });
          });
        }

        await fetchDeposits();
      });

      async function fetchDeposits() {
        const { data: transactions, status } = await apiCall(
          "/api/transactions",
          "GET"
        );
        if (status === 200) {
          const deposits = transactions.filter((tx) => tx.type === "deposit");
          const depositsTableBody =
            document.getElementById("depositsTableBody");
          depositsTableBody.innerHTML = "";

          for (const deposit of deposits) {
            const { data: user, status: userStatus } = await apiCall(
              `/api/admin/users/${deposit.userId}`
            ); // Assuming an endpoint for single user fetch
            if (userStatus !== 200) {
              console.error(
                `Failed to fetch user for deposit ID: ${deposit.id}`
              );
              continue;
            }

            const row = `
              <tr>
                <td class="p-4 font-bold text-white">${user.fullname}</td>
                <td class="p-4">Crypto</td> <!-- Placeholder for method -->
                <td class="p-4 text-lg font-bold text-cyan-400">$${deposit.amount.toLocaleString(
                  undefined,
                  { minimumFractionDigits: 2, maximumFractionDigits: 2 }
                )}</td>
                <td class="p-4">
                  ${
                    deposit.screenshot
                      ? `<button class="view-proof px-3 py-1 rounded bg-slate-700 hover:bg-slate-600 text-xs text-white" data-img="${deposit.screenshot}">View Screenshot</button>`
                      : "N/A"
                  }
                </td>
                <td class="p-4">
                  <span class="px-2 py-1 rounded text-xs ${
                    deposit.status === "approved"
                      ? "bg-green-500/10 text-green-400"
                      : deposit.status === "pending"
                      ? "bg-yellow-500/10 text-yellow-400"
                      : "bg-red-500/10 text-red-400"
                  }">
                    ${deposit.status}
                  </span>
                </td>
                <td class="p-4 text-right space-x-2">
                  ${
                    deposit.status === "pending"
                      ? `
                    <button data-id="${deposit.id}" class="approve-btn px-3 py-1 rounded bg-green-500/20 text-green-400 hover:bg-green-500 hover:text-white font-bold transition">
                      Approve
                    </button>
                    <button data-id="${deposit.id}" class="reject-btn px-3 py-1 rounded bg-red-500/20 text-red-400 hover:bg-red-500 hover:text-white font-bold transition">
                      Reject
                    </button>`
                      : ""
                  }
                </td>
              </tr>
            `;
            depositsTableBody.innerHTML += row;
          }

          // Re-attach event listeners after rendering
          attachEventListeners();
        } else if (status === 401 || status === 403) {
          Ui.alert("error", "Authentication Error", transactions.message).then(
            () => {
              logout();
            }
          );
        } else {
          Ui.alert(
            "error",
            "Failed to fetch deposits",
            transactions.message || "An unknown error occurred."
          );
        }
      }

      function attachEventListeners() {
        // View Proof Logic
        document.querySelectorAll(".view-proof").forEach((btn) => {
          btn.addEventListener("click", () => {
            const imgUrl = btn.getAttribute("data-img");
            Swal.fire({
              imageUrl: imgUrl,
              imageHeight: 400,
              imageAlt: "Payment Proof",
              title: "Proof of Payment",
              background: "#0f172a",
              color: "#fff",
              confirmButtonColor: "#22d3ee",
            });
          });
        });

        // Approve Logic
        document.querySelectorAll(".approve-btn").forEach((btn) => {
          btn.addEventListener("click", async () => {
            const transactionId = btn.getAttribute("data-id");
            Ui.alert(
              "question",
              "Confirm Deposit?",
              "This will credit the user's account."
            ).then(async (result) => {
              if (result.isConfirmed) {
                const { data, status } = await apiCall(
                  `/api/admin/deposits/approve/${transactionId}`,
                  "PUT"
                );
                if (status === 200) {
                  Ui.toast("success", "Deposit Approved & Credited");
                  fetchDeposits(); // Re-fetch to update UI
                } else {
                  Ui.alert(
                    "error",
                    "Approval Failed",
                    data.message || "An error occurred."
                  );
                }
              }
            });
          });
        });

        // Reject Logic
        document.querySelectorAll(".reject-btn").forEach((btn) => {
          btn.addEventListener("click", async () => {
            const transactionId = btn.getAttribute("data-id");
            Ui.alert(
              "warning",
              "Reject Deposit?",
              "The user will be notified."
            ).then(async (result) => {
              if (result.isConfirmed) {
                const { data, status } = await apiCall(
                  `/api/admin/deposits/decline/${transactionId}`,
                  "PUT"
                );
                if (status === 200) {
                  Ui.toast("info", "Deposit Rejected");
                  fetchDeposits(); // Re-fetch to update UI
                } else {
                  Ui.alert(
                    "error",
                    "Rejection Failed",
                    data.message || "An error occurred."
                  );
                }
              }
            });
          });
        });
      }
    </script>
  </body>
</html>
